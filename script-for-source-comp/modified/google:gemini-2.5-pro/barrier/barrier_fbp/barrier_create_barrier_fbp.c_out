predicate barrier(struct barrier *barrier, int n, predicate(int k, bool outgoing) inv;) =
2 <= n &*& malloc_block_barrier(barrier) &*&
barrier->mutex |-> ?mutex &*& barrier->n |-> n &*& mutex(mutex, barrier_inv(barrier, n, inv));
predicate_ctor barrier_inv(struct barrier *barrier, int n, predicate(int k, bool outgoing) inv)() =
barrier->k |-> ?k &*& barrier->outgoing |-> ?outgoing &*& inv(k, outgoing) &*&
outgoing ? 1 <= k &*& k < n : 0 <= k &*& k < n;
struct barrier {
struct mutex *mutex;
int n;
int k;
bool outgoing;
};
struct data {
struct barrier *barrier;
int x1;
int x2;
int y1;
int y2;
int i;
};
struct barrier *create_barrier(int n)
{
struct barrier *barrier = malloc(sizeof(struct barrier));
if (barrier == 0) abort();
barrier->n = n;
barrier->k = 0;
barrier->outgoing = false;
struct mutex *mutex = create_mutex();
barrier->mutex = mutex;
return barrier;
}
